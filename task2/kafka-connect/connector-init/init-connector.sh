#!/bin/sh

# ========================================================
# Скрипт register-connector.sh
# ========================================================
# Описание:
# Этот скрипт ожидает запуска Kafka Connect и затем регистрирует коннектор,
# если он ещё не зарегистрирован.
#
# Действия:
# 1. Ждёт, пока Kafka Connect не станет доступен (порт 8083).
# 2. Проверяет, зарегистрирован ли коннектор с именем "prometheus-connector".
# 3. Если коннектор не зарегистрирован, отправляет HTTP-запрос для его создания.
#
# Зависимости:
# - Kafka Connect должен быть доступен на http://kafka-connect:8083
# - В конфигурации должен быть файл `/config/prometheus-connector.json`
# - Утилита `curl` должна быть установлена в контейнере
#
# ========================================================

# =========================
# Ожидание запуска Kafka Connect
# =========================
echo "Ожидание запуска Kafka Connect..."

# Используем цикл до тех пор, пока Kafka Connect не станет доступным
until curl -s http://kafka-connect:8083/connectors > /dev/null; do
  sleep 5  # Проверяем каждые 5 секунд
done

echo "Kafka Connect запущен."

# =========================
# Проверка наличия зарегистрированного коннектора
# =========================
echo "Проверяем, зарегистрирован ли коннектор prometheus-connector..."

if curl -s http://kafka-connect:8083/connectors | grep -q "prometheus-connector"; then
  echo "Коннектор уже зарегистрирован."
else
  # =========================
  # Регистрация нового коннектора
  # =========================
  echo "Регистрация коннектора..."
  
  # Отправляем HTTP-запрос на создание коннектора, используя JSON-конфигурацию
  RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" -X POST \
    -H "Content-Type: application/json" \
    --data @/config/prometheus-connector.json \
    http://kafka-connect:8083/connectors)

  # Проверяем код ответа
  if [ "$RESPONSE" -eq 201 ]; then
    echo "Коннектор успешно зарегистрирован."
  else
    echo "Ошибка регистрации коннектора. HTTP код: $RESPONSE"
  fi
fi
